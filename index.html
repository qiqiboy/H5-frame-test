<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>html5 测帧率</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,minimal-ui"/>
<meta name="format-detection" content="email=no" />
<meta name="format-detection" content="address=no" />
<meta name="format-detection" content="telephone=no" />
<style type="text/css">
html,body,div,canvas{
    margin:0;padding:0;
}
html,body{
    height:100%;
}
#wrap{
    position:relative;
    height:100%;
}
#canvas{
    width:100%;
    height:100%;
    display:block;
}
.nocanvas{
    text-align:center;
    padding-top:100px;
}
</style>
</head>
<body>
<div id="wrap" class="wrapper">
    <canvas id="canvas"><div class="nocanvas">浏览器不支持canvas<br/>请使用支持canvas的现代浏览器运行本测试</div></canvas>
</div>
<script type="text/javascript" src="js/animation.js"></script>
<script>
var canvas=document.getElementById('canvas'),
    ctx=canvas.getContext && canvas.getContext('2d');

if(ctx){
    var cw=canvas.width=canvas.parentNode.offsetWidth;
    var ch=canvas.height=canvas.parentNode.offsetHeight;
    var co=30;
    
    document.addEventListener('touchmove',function(e){e.preventDefault();},false);
    //画出坐标系

    ctx.strokeStyle=ctx.fillStyle='#666';
    ctx.lineWidth=2;

    ctx.beginPath();
    //画纵向和横向线
    ctx.moveTo(co,co);
    ctx.lineTo(co,ch-co);
    ctx.lineTo(cw-co,ch-co);
    //画向上箭头
    ctx.moveTo(co-5,co+5);
    ctx.lineTo(co,co);
    ctx.lineTo(co+5,co+5);
    //画向右箭头
    ctx.moveTo(cw-co-5,ch-co-5);
    ctx.lineTo(cw-co,ch-co);
    ctx.lineTo(cw-co-5,ch-co+5);
    
    ctx.stroke();

    //画参考线
    var i=1,to;
    ctx.font="12px 'Microsoft YaHei'";
    ctx.fillText('0',co-10,ch-co);
    ctx.fillText('帧率',co-10,co-10);
    ctx.fillText('时间',cw-co-20,ch-co+20);
    while(i<7){
        to=ch-co-((ch-co*2-40)*i/6);
        drawDotted(co+1,to,cw-co,to); 
        ctx.fillText(i++*10,co-20,to+5);
    }
    
    document.addEventListener('DOMContentLoaded',function(e){test();},false);
}

function drawDotted(x,y,x1,y1){
    var len=Math.sqrt(Math.pow(x1-x,2) + Math.pow(y1-y,2)),
        rx=(x1-x)/len,
        ry=(y1-y)/len,
        i=0;
    ctx.strokeStyle='#ccc';
    ctx.lineWidth=1;
    ctx.beginPath();
    while(i<len){
        ctx.moveTo(i*rx+x,i*ry+y);
        i+=5;
        ctx.lineTo(i*rx+x,i*ry+y);
        i+=5;
    }
    ctx.stroke();
}

function test(){
    var x=co+1,y=ch-co,
        w=cw-co*2,h=ch-co*2-40,
        x1=x,y1=y-h,
        ret=[],
        run=function(){
            var num=ret.reduce(function(a,b){
                return a+b;
            },0)/ret.length;
            ctx.beginPath();
            ctx.moveTo(x1,y1);
            ctx.lineTo(x1=x+w*this.percent,y1=y-num/60*h);
            ctx.stroke();

            ret.length=0;
        }
    ctx.strokeStyle='blue';
    ctx.fillStyle='green';
    new Animation(20000).next(function(frameTime){
        if(frameTime){
            ret.push(Math.min(Math.floor(1000/frameTime),60));
        }
        //渲染圆
        ctx.beginPath();
        ctx.arc(x+(w-20)*this.percent+10,co+20,10,0,Math.PI*2);
        ctx.fill();
    }).frame(100,run).finish(run).start();
}
</script>
</body>
</html>
